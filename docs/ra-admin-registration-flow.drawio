<mxfile host="app.diagrams.net" modified="2026-02-04T00:00:00.000Z" agent="Claude" version="21.0.0" type="device">
  <diagram id="ra-admin-registration" name="RA Admin Registration Flow">
    <mxGraphModel dx="1800" dy="1200" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;RA Admin User Registration &amp; Authentication Flow&lt;/b&gt;" style="text;html=1;fontSize=20;fontStyle=1;align=center;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- ==================== SWIM LANES ==================== -->
        <!-- Client/Browser Lane -->
        <mxCell id="lane_client" value="&lt;b&gt;Client / Browser&lt;/b&gt;" style="swimlane;startSize=30;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=13;horizontal=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="80" width="300" height="1100" as="geometry" />
        </mxCell>

        <!-- RA Application Lane -->
        <mxCell id="lane_ra" value="&lt;b&gt;RA Application (Spring Boot)&lt;/b&gt;" style="swimlane;startSize=30;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;fontSize=13;horizontal=1;" vertex="1" parent="1">
          <mxGeometry x="340" y="80" width="400" height="1100" as="geometry" />
        </mxCell>

        <!-- Active Directory Lane -->
        <mxCell id="lane_ad" value="&lt;b&gt;Active Directory (LDAP)&lt;/b&gt;" style="swimlane;startSize=30;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;fontSize=13;horizontal=1;" vertex="1" parent="1">
          <mxGeometry x="760" y="80" width="340" height="1100" as="geometry" />
        </mxCell>

        <!-- IdP Lane -->
        <mxCell id="lane_idp" value="&lt;b&gt;Identity Provider (IdP)&lt;/b&gt;" style="swimlane;startSize=30;fillColor=#e1d5e7;strokeColor=#9673a6;fontStyle=1;fontSize=13;horizontal=1;" vertex="1" parent="1">
          <mxGeometry x="1120" y="80" width="300" height="1100" as="geometry" />
        </mxCell>

        <!-- ==================== PHASE 1: USER CREATION IN AD ==================== -->
        <mxCell id="phase1_label" value="&lt;b&gt;PHASE 1: Create User in Active Directory&lt;/b&gt;" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="110" width="1400" height="30" as="geometry" />
        </mxCell>

        <!-- Step 1: Admin sends POST request -->
        <mxCell id="s1_start" value="IT Admin" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="140" y="160" width="40" height="60" as="geometry" />
        </mxCell>

        <mxCell id="s1_request" value="&lt;b&gt;POST /api/v1/ad-users&lt;/b&gt;&lt;br&gt;{samAccountName, firstName,&lt;br&gt;lastName, email, department,&lt;br&gt;userPrincipalName}" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left;" vertex="1" parent="1">
          <mxGeometry x="50" y="240" width="220" height="80" as="geometry" />
        </mxCell>

        <mxCell id="s1_arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#6c8ebf;strokeWidth=2;" edge="1" parent="1" source="s1_request" target="s1_controller">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Controller -->
        <mxCell id="s1_controller" value="&lt;b&gt;AdUserController&lt;/b&gt;&lt;br&gt;create(@Valid AdUserDto)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="390" y="250" width="200" height="50" as="geometry" />
        </mxCell>

        <mxCell id="s1_arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="s1_controller" target="s1_service">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Service -->
        <mxCell id="s1_service" value="&lt;b&gt;AdUserService&lt;/b&gt;&lt;br&gt;1. Check duplicate user&lt;br&gt;2. Convert DTO → Model&lt;br&gt;3. Call repository.create()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="330" width="200" height="70" as="geometry" />
        </mxCell>

        <mxCell id="s1_arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1" source="s1_service" target="s1_ldap">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- LDAP Repository -->
        <mxCell id="s1_ldap" value="&lt;b&gt;AdUserLdapRepository&lt;/b&gt;&lt;br&gt;ldapTemplate.bind(context)&lt;br&gt;&lt;br&gt;Creates LDAP entry:&lt;br&gt;CN=user, OU=Users&lt;br&gt;objectClass: [top, person,&lt;br&gt;organizationalPerson, user]" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="250" width="230" height="120" as="geometry" />
        </mxCell>

        <mxCell id="s1_response" value="&lt;b&gt;201 Created&lt;/b&gt;&lt;br&gt;Returns AdUserDto" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="160" width="140" height="50" as="geometry" />
        </mxCell>

        <mxCell id="s1_arrow_resp" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#82b366;strokeWidth=1;dashed=1;" edge="1" parent="1" source="s1_response" target="s1_request">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ==================== PHASE 2: AD GROUP ASSIGNMENT ==================== -->
        <mxCell id="phase2_label" value="&lt;b&gt;PHASE 2: Assign User to RA Admin Group in AD&lt;/b&gt;" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="420" width="1400" height="30" as="geometry" />
        </mxCell>

        <mxCell id="s2_admin_action" value="&lt;b&gt;AD Admin assigns user&lt;br&gt;to PKI-RA-Admins group&lt;/b&gt;&lt;br&gt;&lt;br&gt;(via LDAP modify or&lt;br&gt;AD Users &amp; Computers)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="70" y="470" width="190" height="80" as="geometry" />
        </mxCell>

        <mxCell id="s2_arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1" source="s2_admin_action" target="s2_group">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s2_group" value="&lt;b&gt;AD Group: PKI-RA-Admins&lt;/b&gt;&lt;br&gt;&lt;br&gt;memberOf attribute updated:&lt;br&gt;CN=PKI-RA-Admins,&lt;br&gt;OU=Groups,DC=company,DC=com&lt;br&gt;&lt;br&gt;&lt;b&gt;Role Mapping:&lt;/b&gt;&lt;br&gt;PKI-RA-Admins → RA_ADMIN&lt;br&gt;PKI-RA-Officers → RA_OFFICER&lt;br&gt;PKI-RA-Operators → RA_OPERATOR&lt;br&gt;PKI-Auditors → AUDITOR" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="450" width="230" height="180" as="geometry" />
        </mxCell>

        <!-- ==================== PHASE 3: JWT AUTHENTICATION ==================== -->
        <mxCell id="phase3_label" value="&lt;b&gt;PHASE 3A: JWT Challenge-Response Authentication (REST API)&lt;/b&gt;" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="660" width="1400" height="30" as="geometry" />
        </mxCell>

        <!-- Step 3a: Challenge Request -->
        <mxCell id="s3a_challenge_req" value="&lt;b&gt;Step 1: Request Challenge&lt;/b&gt;&lt;br&gt;POST /api/v1/auth/challenge&lt;br&gt;{username: &quot;admin_user&quot;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="710" width="210" height="55" as="geometry" />
        </mxCell>

        <mxCell id="s3a_arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#6c8ebf;strokeWidth=2;" edge="1" parent="1" source="s3a_challenge_req" target="s3a_auth_ctrl">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s3a_auth_ctrl" value="&lt;b&gt;AuthenticationController&lt;/b&gt;&lt;br&gt;requestChallenge()&lt;br&gt;&lt;br&gt;Generates:&lt;br&gt;• 32-byte random nonce&lt;br&gt;• 16-byte PBKDF2 salt&lt;br&gt;• 5-min expiry" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="700" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- Step 3b: Client encrypts -->
        <mxCell id="s3b_encrypt" value="&lt;b&gt;Step 2: Client-side Crypto&lt;/b&gt;&lt;br&gt;• PBKDF2(password, salt,&lt;br&gt;  10000 iters, 256-bit key)&lt;br&gt;• AES-256-GCM encrypt(challenge)" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="800" width="230" height="80" as="geometry" />
        </mxCell>

        <!-- Step 3c: Login -->
        <mxCell id="s3c_login" value="&lt;b&gt;Step 3: Submit Login&lt;/b&gt;&lt;br&gt;POST /api/v1/auth/login&lt;br&gt;{username, challengeId,&lt;br&gt;encryptedResponse}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="910" width="210" height="60" as="geometry" />
        </mxCell>

        <mxCell id="s3c_arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#6c8ebf;strokeWidth=2;" edge="1" parent="1" source="s3c_login" target="s3c_auth_ctrl">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s3c_auth_ctrl" value="&lt;b&gt;AuthenticationController&lt;/b&gt;&lt;br&gt;authenticate()&lt;br&gt;&lt;br&gt;1. Validate challengeId&lt;br&gt;2. Verify encrypted response" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="830" width="200" height="80" as="geometry" />
        </mxCell>

        <mxCell id="s3c_arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1" source="s3c_auth_ctrl" target="s3c_ad_auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s3c_ad_auth" value="&lt;b&gt;ActiveDirectoryService&lt;/b&gt;&lt;br&gt;&lt;br&gt;authenticate(username)&lt;br&gt;→ Search AD by UPN/SAM&lt;br&gt;→ Verify user is active&lt;br&gt;&lt;br&gt;getUserDetails(username)&lt;br&gt;→ Fetch: cn, mail, ou, memberOf&lt;br&gt;→ Map groups to roles:&lt;br&gt;&lt;b&gt;PKI-RA-Admins → RA_ADMIN&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="800" width="230" height="150" as="geometry" />
        </mxCell>

        <!-- JWT Generation -->
        <mxCell id="s3c_jwt" value="&lt;b&gt;JWTTokenService&lt;/b&gt;&lt;br&gt;generateToken()&lt;br&gt;&lt;br&gt;JWT Claims:&lt;br&gt;sub=admin_user&lt;br&gt;roles=[RA_ADMIN, END_ENTITY]&lt;br&gt;exp=24h, issuer=RA-Service&lt;br&gt;Signed: HS256" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="940" width="200" height="110" as="geometry" />
        </mxCell>

        <mxCell id="s3c_arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="s3c_ad_auth" target="s3c_jwt">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="750" y="875" />
              <mxPoint x="750" y="995" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- JWT Response back to client -->
        <mxCell id="s3c_jwt_resp" value="&lt;b&gt;JWT Token Response&lt;/b&gt;&lt;br&gt;{token: &quot;eyJhbGc...&quot;,&lt;br&gt;tokenType: &quot;Bearer&quot;,&lt;br&gt;expiresIn: 86400,&lt;br&gt;roles: [&quot;RA_ADMIN&quot;]}" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="1000" width="210" height="80" as="geometry" />
        </mxCell>

        <mxCell id="s3c_arrow_resp" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#82b366;strokeWidth=1;dashed=1;" edge="1" parent="1" source="s3c_jwt" target="s3c_jwt_resp">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ==================== PHASE 3B: SAML AUTHENTICATION ==================== -->
        <mxCell id="phase3b_label" value="&lt;b&gt;PHASE 3B: SAML 2.0 SSO Authentication (Web UI - Alternative)&lt;/b&gt;" style="text;html=1;fontSize=12;fontStyle=1;align=left;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1120" y="660" width="300" height="30" as="geometry" />
        </mxCell>

        <mxCell id="s3b_saml_flow" value="&lt;b&gt;SAML SSO Flow&lt;/b&gt;&lt;br&gt;&lt;br&gt;1. Browser → /login&lt;br&gt;2. Redirect to IdP&lt;br&gt;3. IdP authenticates via AD&lt;br&gt;4. SAML Assertion returned:&lt;br&gt;   • email, firstName, lastName&lt;br&gt;   • role: RA_ADMIN&lt;br&gt;5. SAMLUser.fromSAMLAssertion()&lt;br&gt;6. getPrimaryRole() → RA_ADMIN&lt;br&gt;7. Redirect → /admin/dashboard" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1140" y="710" width="250" height="170" as="geometry" />
        </mxCell>

        <mxCell id="s3b_saml_config" value="&lt;b&gt;SAMLSecurityConfig&lt;/b&gt;&lt;br&gt;&lt;br&gt;/admin/** → hasRole(RA_ADMIN)&lt;br&gt;/officer/** → hasAnyRole(...)&lt;br&gt;/operator/** → hasAnyRole(...)&lt;br&gt;&lt;br&gt;saml2Login: /login&lt;br&gt;defaultSuccessUrl: /dashboard" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1140" y="910" width="250" height="120" as="geometry" />
        </mxCell>

        <mxCell id="s3b_arrow_saml" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#9673a6;strokeWidth=1;" edge="1" parent="1" source="s3b_saml_flow" target="s3b_saml_config">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ==================== PHASE 4: ACCESS PROTECTED RESOURCES ==================== -->
        <mxCell id="phase4_label" value="&lt;b&gt;PHASE 4: Access Protected RA Resources (with JWT)&lt;/b&gt;" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="1100" width="1400" height="30" as="geometry" />
        </mxCell>

        <mxCell id="s4_request" value="&lt;b&gt;API Request with JWT&lt;/b&gt;&lt;br&gt;Authorization: Bearer eyJ...&lt;br&gt;&lt;br&gt;GET /api/v1/certificate-requests" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="1150" width="210" height="60" as="geometry" />
        </mxCell>

        <mxCell id="s4_arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#6c8ebf;strokeWidth=2;" edge="1" parent="1" source="s4_request" target="s4_filter">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s4_filter" value="&lt;b&gt;JWTAuthenticationFilter&lt;/b&gt;&lt;br&gt;&lt;br&gt;1. Extract token from header&lt;br&gt;2. Validate signature &amp; expiry&lt;br&gt;3. Extract username &amp; roles&lt;br&gt;4. Set SecurityContext with&lt;br&gt;   authorities: [ROLE_RA_ADMIN]" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="1140" width="200" height="110" as="geometry" />
        </mxCell>

        <mxCell id="s4_arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="s4_filter" target="s4_preauth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="s4_preauth" value="&lt;b&gt;@PreAuthorize&lt;/b&gt;&lt;br&gt;hasRole('RA_ADMIN')&lt;br&gt;&lt;br&gt;✓ ROLE_RA_ADMIN found&lt;br&gt;→ Access GRANTED" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="800" y="1150" width="220" height="80" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="&lt;b&gt;Legend&lt;/b&gt;" style="swimlane;startSize=25;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1120" y="1100" width="300" height="140" as="geometry" />
        </mxCell>
        <mxCell id="leg1" value="Client / Browser" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="10" y="35" width="130" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg2" value="RA Application" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="155" y="35" width="130" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg3" value="Active Directory" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="10" y="70" width="130" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg4" value="SAML / IdP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="legend">
          <mxGeometry x="155" y="70" width="130" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg5" value="→ Request flow  ⇢ Response flow" style="text;html=1;fontSize=10;align=left;" vertex="1" parent="legend">
          <mxGeometry x="10" y="105" width="270" height="25" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
